<!DOCTYPE HTML>
<html lang="en">
    <head>
        <meta charset="UTF-8">
        <title>Internals - book-mk Documentation</title>
        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">

        <base href="">

        <link rel="stylesheet" href="book.css">
        <link href="https://fonts.googleapis.com/css?family=Open+Sans:300italic,400italic,600italic,700italic,800italic,400,300,600,700,800" rel="stylesheet" type="text/css">
        <link href="https://fonts.googleapis.com/css?family=Source+Code+Pro:500" rel="stylesheet" type="text/css">

        <link rel="shortcut icon" href="favicon.png">

        <!-- Font Awesome -->
        <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.3.0/css/font-awesome.min.css">

        <link rel="stylesheet" href="highlight.css">
        <link rel="stylesheet" href="tomorrow-night.css">

        <!-- MathJax -->
        <script type="text/javascript" src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>

        <!-- Fetch JQuery from CDN but have a local fallback -->
        <script src="https://code.jquery.com/jquery-2.1.4.min.js"></script>
        <script>
            if (typeof jQuery == 'undefined') {
                document.write(unescape("%3Cscript src='jquery.js'%3E%3C/script%3E"));
            }
        </script>
    </head>
    <body class="light">
        <!-- Set the theme before any content is loaded, prevents flash -->
        <script type="text/javascript">
            var theme = localStorage.getItem('theme');
            if (theme == null) { theme = 'light'; }
            $('body').removeClass().addClass(theme);
        </script>

        <!-- Hide / unhide sidebar before it is displayed -->
        <script type="text/javascript">
            var sidebar = localStorage.getItem('sidebar');
            if (sidebar === "hidden") { $("html").addClass("sidebar-hidden") }
            else if (sidebar === "visible") { $("html").addClass("sidebar-visible") }
        </script>

        <div id="sidebar" class="sidebar">
            <ul class="chapter"><li><a href="introduction.html"><strong>1.</strong> Introduction</a></li><li><a href="usage.html"><strong>2.</strong> Usage</a></li><li><a href="customization.html"><strong>3.</strong> Customization</a></li><li><a href="internals.html" class="active"><strong>4.</strong> Internals</a></li><li class="affix"><a href="bibliography.html">Bibliography</a></li></ul>
        </div>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                <div id="menu-bar" class="menu-bar">
                    <div class="left-buttons">
                        <i id="sidebar-toggle" class="fa fa-bars"></i>
                        <i id="theme-toggle" class="fa fa-paint-brush"></i>
                    </div>

                    <h1 class="menu-title">book-mk Documentation</h1>

                    <div class="right-buttons">
                        <i id="print-button" class="fa fa-print" title="Print this book"></i>
                    </div>
                </div>

                <div id="content" class="content">
                    <h1 id="sec:internals"><span class="header-section-number">4</span> Internals</h1>
<pre><code>src -------&gt; target/stage ------&gt; target/&lt;format&gt;
    frontend              backend</code></pre>
<ul>
<li>Frontend (Sec. <a href="internals.html#sec:frontend">4.1</a>): format-independent processing through Pandoc</li>
<li>Backend (Secs. <a href="internals.html#sec:html-output">4.2.1</a>, <a href="internals.html#sec:pdf-output">4.2.2</a>): format-specific rendering through Pandoc and mdBook/LaTeX</li>
</ul>
<h2 id="sec:frontend"><span class="header-section-number">4.1</span> Frontend</h2>
<pre><code>src/*.md

    |
    | prepend-heading
    v

[md]

    |
    | pandoc (frontend)
    v

[json]

    |
    | preprocessor
    v

target/stage/src/*.json</code></pre>
<p>Each Markdown file is transformed individually into an output-independent JSON file using Pandoc. The use of JSON ensures that all the details are preserved correctly, including citations (which would get lost if HTML was used for intermediate files). The preprocessor is not yet implemented.</p>
<p>The transformation of each file is independent of each other; there is no state maintained.</p>
<p>Still, even though the transformations are totally independent, the makefile has to know which files need to be transformed. This is what <code>target/stage/src/SUMMARY.mk</code> stores: a list of the book items in the correct ordering as a makefile variable <code>$(item_names)</code>. It is obtained via <code>.local/bin/get-book-items</code>.</p>
<h2 id="backend"><span class="header-section-number">4.2</span> Backend</h2>
<p>Using the files in the staging directory (<code>target/stage</code>), we use mdBook to parse the structure of the book items (chapters, sections, etc) in <code>SUMMARY.md</code> and render the output files. This is handled by the following custom Rust tools:</p>
<ul>
<li><code>html-mdbook-toml</code>, which translates the Makefile variable <code>$(metadata)</code> into <code>target/stage/html/book.toml</code> for mdBook.</li>
<li><code>html-merge</code>: combines the input files into an amalgamation so that <code>pandoc-crossref</code> works correctly (also appends the bibliography if present)</li>
<li><code>html-fix-links</code>: make the links in an amalgamation work correctly after splitting</li>
<li><code>html-split</code>: splits the amalgamation back into individual pages for <code>mdbook</code></li>
<li><code>latex-merge</code>, reads <code>SUMMARY.md</code> and combines the various <code>target/stage/src/*.json</code> files into a single JSON file <code>target/pdf/book.json</code> to be consumed by Pandoc for PDF generation.</li>
</ul>
<h3 id="sec:html-output"><span class="header-section-number">4.2.1</span> HTML Output</h3>
<pre><code>target/stage/src/*.json

        |
        | html-merge
        v

[json]

        |
        | pandoc-crossref
        | +
        | pandoc-citeproc
        | +
        | html-fix-links
        | +
        | pandoc (HTML)
        v

[html]

        |
        | html-split
        v

target/stage/html/src/*.htm

        |
        | mdbook
        v

target/html</code></pre>
<p>The JSON files are translated into <code>.htm</code> using Pandoc. The choice of <code>.htm</code> instead of <code>.html</code> is mainly to work around an mdBook quirk.</p>
<p>In principle, this one should be straightforward: just call <code>mdbook build &lt;dir&gt;</code>. In practice, we have to use a patched version of mdBook because we want to render Markdown using Pandoc rather than the default pulldown-cmark.</p>
<h4 id="the-mdbook-patch"><span class="header-section-number">4.2.1.1</span> The mdBook patch</h4>
<p>We use a patched version of mdBook that renders directly through HTML rather than through Markdown. This is because we use want to use Pandoc to preprocess the input files and “standard” Markdown is not very expressive.</p>
<p>Originally, the plan was to preprocess with Pandoc and save them as CommonMark so that mdBook could parse them. However, the problem is that (a) Pandoc does not support a lossless conversion to CommonMark (b) pulldown-cmark does not adhere to CommonMark very well (e.g. it does not preserve whitespace within <code>&lt;pre&gt;</code> elements as the spec demands).</p>
<p>Therefore, we simply disable the Markdown processing altogether and use HTML. To avoid duplicating a large chunk of code from mdBook, so we opted to just patch the original code instead.</p>
<h4 id="using-.htm-instead-of-.html"><span class="header-section-number">4.2.1.2</span> Using <code>.htm</code> instead of <code>.html</code></h4>
<p>After rendering, mdBook copies all files except <code>.md</code> files into the output directory. If we named the input files <code>.html</code> they would immediately overwrite the files we just generated! Moreover, using <code>.htm</code> makes it easy to delete the input files from the output directory afterward.</p>
<h4 id="keeping-targethtml-tidy"><span class="header-section-number">4.2.1.3</span> Keeping <code>target/html</code> tidy</h4>
<p>Part of the reason to have <code>target/stage</code> is so that we can select precisely what files we want. mdBook is not very selective so it will copy everything in <code>src</code> into <code>dest</code> and then purge all the <code>.md</code> files.</p>
<h3 id="sec:pdf-output"><span class="header-section-number">4.2.2</span> PDF Output</h3>
<pre><code>target/stage/src/*.json

        |
        | latex-merge
        v

target/pdf/book{_head.tex,{_before,,_after}.json}

        |
        | pandoc-multiref
        | +
        | pandoc (LaTeX)
        v

target/pdf/book.tex

        |
        | latexmk
        v

target/pdf/book.pdf</code></pre>
<p><code>latex-merge</code> is responsible for combining the chapters together into a single JSON file, shifting the heading levels as necessary. Then <code>Pandoc</code> is invoked to generate the <code>.tex</code> file. Finally we run <code>latexmk</code> to produce the PDF.</p>
<p>The main reason for invoking <code>Pandoc</code> within <code>latexbook</code> is because there are auxiliary files (e.g. frontmatter file) that would otherwise get entangled with the Makefile.</p>
<h4 id="location-of-the-.bib-file"><span class="header-section-number">4.2.2.1</span> Location of the <code>.bib</code> file</h4>
<p>It’s much easier to have the <code>.bib</code> file at the top-level. The reason is that we want it to work with both <code>pandoc-citeproc</code>, which treats it as a path relative to the top-level directory, and <code>natbib</code>, which treats it as a path relative to <code>target/pdf</code>. If we put it inside <code>src</code>, then <code>pandoc-citeproc</code> would complain, and mdbook would unwittingly copy the <code>.bib</code> file into <code>target/html</code>.</p>
<p>Example of a bibliographic citation: <span class="citation" data-cites="testitem">(Doe <a href="bibliography.html#ref-testitem">2000</a>)</span></p>

                </div>

                <!-- Mobile navigation buttons -->
                
                    <a href="customization.html" class="mobile-nav-chapters previous">
                        <i class="fa fa-angle-left"></i>
                    </a>
                

                
                    <a href="bibliography.html" class="mobile-nav-chapters next">
                        <i class="fa fa-angle-right"></i>
                    </a>
                

            </div>

            
                <a href="customization.html" class="nav-chapters previous" title="You can navigate through the chapters using the arrow keys">
                    <i class="fa fa-angle-left"></i>
                </a>
            

            
                <a href="bibliography.html" class="nav-chapters next" title="You can navigate through the chapters using the arrow keys">
                    <i class="fa fa-angle-right"></i>
                </a>
            

        </div>


        <!-- Local fallback for Font Awesome -->
        <script>
            if ($(".fa").css("font-family") !== "FontAwesome") {
                $('<link rel="stylesheet" type="text/css" href="_FontAwesome/css/font-awesome.css">').prependTo('head');
            }
        </script>

        <!-- Livereload script (if served using the cli tool) -->
        

        <script src="highlight.js"></script>
        <script src="book.js"></script>
    </body>
</html>
